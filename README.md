# Pentesting-Lab-with-Microsoft-Sentinel

The contents of this repository outline the construction of a virtual pentesting lab within Microsoft Azure, hosting an instance
of OWASP's Buggy Web Application, and the deployment and configuration of Azure's cloud-native SIEM, Microsoft Sentinel, to monitor the environment.

This document contains the following sections:


Network Topology Description                                              
Access Policies                                       
Deployment of Microsoft Sentinel


To view a slide presentation of this project, you can find it under the folder "Presentation".                                


                                                                                                      
## **Network Topology**

![Network_Topology](https://user-images.githubusercontent.com/129786707/236310665-fb9e361c-e003-4b3e-b690-443463af08d0.png)

All resources, aside from my own computer, are within Microsoft Azure.

There are two resources with public IP addresses: our jump box provisioner and the load balancer for our web servers. For the purposes of this lab, my own IP address is whitelisted in our Network Security Group rules. (note: while whitelisting an IP address will only allow said IP authorized access to resources within the virtual network, this does not prevent attempts at unauthorized access to resources with a public-facing IP address, as part of this lab will demonstrate).

The details of each machine are listed below:


|   Name        |  Function     |  IP Address  |  OS   |
| ------------ | ------------- | ----- | --- |
| Jump Box | Gateway | 10.0.0.4 | Linux Ubuntu |
| Web1 | Web Server | 10.0.0.5 | Linux Ubuntu |
| Web2 | Web Server | 10.0.0.6 | Linux Ubuntu |
| Web3 | Web Server | 10.0.0.7 | Linux Ubuntu |



Our Ansible container is configured as a provisioner for our web servers. This offers not only convenience from an administrative standpoint, as this allows us to configure our web servers automatically from a centralized location, but also ensures that each server will be configured identically with the same playbook. This concept is referred to as “infrastructure as code”.

The Ansible playbook used to configure the deployment of our Buggy Web Application via Docker can be found here:

![pentest.yml](https://github.com/Cory-Wurtz/Pentesting-Lab-with-Microsoft-Sentinel/blob/main/pentest.yml)

After running the playbook, we can SSH into any of our web servers and run a command listing our Docker Containers
to ensure they are deployed and running: 

![Deployed_BWAPP_Containers](https://user-images.githubusercontent.com/129786707/236060639-3fc59c45-ba36-4d7a-86ba-bd3d82fe1211.png)

The public IP address of the load balancer allows HTTP connections to the internal web servers (provided they are powered on with the Docker containers running). The load balancer is configured to distribute HTTP requests evenly between the three servers, ensuring a high level of availability as well as providing a layer of security from denial-of-service attacks.

We can enter the URL with our load balancer's public IP address as the domain name ending with '/install.php' and confirm that our application is accessible:


![Confirmed_BWAPP_Deployment](https://user-images.githubusercontent.com/129786707/236314590-1d498c1f-87b2-40d2-93c0-7dddbc600166.png)




## **Access Policies**

We have configured a ‘fan-in’ pattern for administrative access to our resources within our VNET. Our jump box is configured to only accept connections via secure-shell (SSH) from my own IP address, and the machines hosting our web application are configured to only accept SSH connections internally from our jump box. Since using SSH with a password is inherently weak, we have generated asymmetric key-pairs that only allow access to those holding the private keys, one on my computer for jump box access, and another within the Ansible provisioning node the jump box is hosting for accessing the internal web servers.

A summary of the access policies are listed below: 


|   Name        |  Publicly Accessible     |  Allowed IP  |
| ------------ | ------------- | ----- |
| Load Balancer | Yes | Personal/Open |
| Jump Box | Yes | Personal|
| Web1 | No | 10.0.0.4 |
| Web2 | No | 10.0.0.4 |
| Web3 | No | 10.0.0.4 |

We also have several rules configured in our Network Security Group. A table outlining the details of those rules is listed below:

| Name | Description|
| --- | --- |
| DefaultDeny | Denies all traffic by default, unless allowed here |
| AllowSSH--MyIP | Allows SSH connections from my personal IP address to the jump box |
| AllowSSH--JumpBoxIP | Allows SSH connections to the internal VNET from the jump box |
| AllowHTTPS--Monitor | Allows HTTPS traffic to the VNET from Azure Monitor |
| AllowHTTP--LB | Allows HTTP traffic to the load balancer |

## **Deployment of Sentinel**

Microsoft Sentinel, like any SIEM, is built on data-ingestion. Our primary data-ingestion agents for this deployment will 
include Azure Monitor for our VMs and Network Watcher for our Network Security Group flow logs, though Sentinel's capabilities
are not only limited to resources within Azure.

Before we can install our monitoring agents, we first need a place to send the logs. Our Log Analytics Workspace will serve as our repository for all of our logs and telemetry data. Once our agents are configured and populating our Workspace, we can deploy Microsoft Sentinel on top of it and apply our data connectors.
The following two screenshots confirm the deployment of our agents:

Azure Monitor:                                                      
![Azure_monitor_deployment](https://user-images.githubusercontent.com/129786707/236334297-3a441f3f-ed67-4081-8364-041fd7a92e50.png)

Network Watcher/Flow Logs:
![Flow_Log_Deployment](https://user-images.githubusercontent.com/129786707/236334310-53d22fd8-f841-4684-8eeb-7577b6bef88b.png)


From the Sentinel portal, we will deploy data connectors that feed the logs from our Analytics Workspace into Sentinel, where we can view the data in dashboards
known as workbooks. The screenshot below is a display of our workbook for our Security Group flow logs:

![Flowlog_dashboard](https://user-images.githubusercontent.com/129786707/236334781-5735592f-a5f8-4e0f-8c69-bf9d16149b8d.png)

Our analytics rules provide the backbone of our alert and incident generation within Sentinel. As an example, I have configured a rule

